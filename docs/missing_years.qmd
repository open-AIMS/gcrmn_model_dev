---
title: "Comparing model types - missing years"
author: "Murray Logan"
date: today
date-format: "DD/MM/YYYY"
format:
  html:
    ## Format
    theme: [default, resources/style.scss]
    css: resources/style.css
    html-math-method: mathjax
    ## Table of contents
    toc: true
    toc-float: true
    ## Numbering
    number-sections: true
    number-depth: 3
    ## Layout
    page-layout: full
    fig-caption-location: "bottom"
    fig-align: "center"
    fig-width: 4
    fig-height: 4
    out-width: 500px
    fig-dpi: 72
    tbl-cap-location: top
    ## Code
    code-fold: false
    code-tools: true
    code-summary: "Show the code"
    code-line-numbers: true
    code-block-border-left: "#ccc"
    code-copy: true
    highlight-style: atom-one
    ## Execution
    execute:
      echo: true
      #cache: true
    ## Rendering
    embed-resources: true
crossref:
  fig-title: '**Figure**'
  fig-labels: arabic
  tbl-title: '**Table**'
  tbl-labels: arabic
engine: knitr
## execute: 
##   cache: true
jupyter: python3
output_dir: "docs"
documentclass: article
fontsize: 12pt
mainfont: Arial
mathfont: LiberationMono
monofont: DejaVu Sans Mono
classoption: a4paper
bibliography: resources/references.bib
---

```{r}
#| label: setup
#| include: false

knitr::opts_chunk$set(
    cache.lazy = FALSE,
    tidy = "styler"
)
## allow indented chunks
assignInNamespace(".sep.label",
  "^\\ *(#|--)+\\s*(@knitr|----+)(.*?)-*\\s*$",
    ns = "knitr"
)
knitr::read_chunk("../R/site_replacement.R")
knitr::read_chunk("../R/missing_years.R")
knitr::read_chunk("../python/missing_years.py")
## knitr::read_chunk("../python/site_replacement.py")
## remove the indentation from all python chunks that start
## with indentation
codes <- knitr::knit_code$get()
process_chunks <- function(codes) {
  nms <- names(codes)
  wch <- which(startsWith(names(codes), "python"))
  codes1 <- lapply(1:length(codes), function(i) {
    if (i %in% wch) {
      x <- gsub("^ {4}", "", codes[[i]])
    } else {
      x <- codes[[i]]
    }
    x
  })
  names(codes1) <- nms
  codes1
}
knitr::knit_code$set(
  process_chunks(codes)
)
```

```{css, echo=FALSE}
figcaption {
  text-align: left !important;
}
```

## Purpose

Still to come

## Conclusions

Still to come

## Preparations

::: {.panel-tabset}

### R

```{r}
#| label: cwd
#| eval: false
#| echo: false
#| warning: false
#| message: false
#| cache: false
getwd()
```

Load the necessary R libraries

```{r}
#| label: site replacement libraries
#| output: false
#| eval: true
#| warning: false
#| message: false
#| cache: false
```

Establish the global environment and paths

```{r}
#| label: site replacement global parameters
#| results: hide
#| eval: true
#| echo: true
#| cache: false
```

Load any helper functions

```{r}
#| label: site replacement functions
#| results: hide
#| eval: false
#| echo: true
#| cache: false
```

### Python

```{python}
#| label: python missing years libraries
#| output: false
#| eval: true
#| warning: false
#| message: false
#| cache: false
```

```{python}
#| label: python missing years global parameters
#| results: hide
#| eval: true
#| echo: true
#| cache: false
```
:::

## Import data

::: {.panel-tabset}

### R

:::: {.panel-tabset}

#### 1. Full reef level spatio-temporal benthic data

These data represent the synthesized "truth" and are thereby useful to
compare to the various modelled outcomes.

![](../output/figures/R_all_temporal_summary_plot.png){width=500px}

```{r}
#| label: read all reefs data
#| results: markup
#| eval: true
#| echo: true
#| cache: true
```

```{r}
#| label: read all reefs data show
#| results: markup
#| eval: true
#| echo: true
#| cache: true
#| dependson: "read all reefs data"
#| code-fold: false
benthos_reefs_sf 
```

```{r}
#| label: all reefs temporal summary
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

```{r}
#| label: all reefs temporal summary plot
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| code-fold: true
#| cache: true
#| dependson: "read all reefs data"
```

#### 2. All sampled reefs

These data represent a simulated sampling design in which 25 fixed
(though randomly selected from among all the defined reefs in the
synthetic spatial domain) reefs are monitored over a continuous 12
year period.

![](../output/figures/R_full_simple_raw_means_plot.png){width=500px}

```{r}
#| label: read sampled reefs data
#| results: markup
#| echo: true
#| cache: false
#| dependson: "read all reefs data"
```

```{r}
#| label: read sampled reefs data show
#| results: markup
#| eval: true
#| echo: true
#| cache: false
#| dependson: "read all reefs data"
#| code-fold: false
benthos_fixed_locs_obs 
```

```{r}
#| label: sampled simple raw means
#| results: markup
#| eval: false
#| echo: true
#| code-fold: true
#| cache: false
#| dependson: "read sampled reefs data"
```

```{r}
#| label: sampled simple raw means plot
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| code-fold: true
#| cache: false
#| dependson: "read sampled reefs data"
```

#### 3. Temporal gap in some reefs

These data represent the fixed 25 sites, however some of the reefs
have a temporal gap between years 2 and 6.

![](../output/figures/R_sampled_reefs_3_plot.png){width=500px}

```{r}
#| label: read sampled reefs data 3
#| results: markup
#| echo: true
#| cache: false
#| dependson: "read all reefs data"
```

```{r}
#| label: read sampled reefs data 3 show
#| results: markup
#| eval: true
#| echo: true
#| cache: false
#| dependson: "read all reefs data"
#| code-fold: false
benthos_fixed_locs_obs_3 
```

```{r}
#| label: sampled reefs data 3 plot
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| code-fold: true
#| cache: false
#| dependson: "read sampled reefs data"
```

#### 4. Temporal gap in all reefs

These data represent the fixed 25 sites, however all of the reefs
have a temporal gap between years 2 and 6.

![](../output/figures/R_sampled_reefs_4_plot.png){width=500px}

```{r}
#| label: read sampled reefs data 4
#| results: markup
#| echo: true
#| cache: false
#| dependson: "read all reefs data"
```

```{r}
#| label: read sampled reefs data 4 show
#| results: markup
#| eval: true
#| echo: true
#| cache: false
#| dependson: "read all reefs data"
#| code-fold: false
benthos_fixed_locs_obs_4 
```

```{r}
#| label: sampled reefs data 4 plot
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| code-fold: true
#| cache: false
#| dependson: "read sampled reefs data"
```

::::

### Python

:::: {.panel-tabset}

#### 1. Full reef level spatio-temporal benthic data

These data represent the synthesized "truth" and are thereby useful to
compare to the various modelled outcomes.

![](../output/figures/Python_all_temporal_summary_plot.png){width=500px}

```{python}
#| label: python missing years read all reefs data 3
#| results: markup
#| eval: true
#| echo: true
#| cache: true
```

```{python}
#| label: python missing years read all reefs data show 3
#| results: markup
#| eval: true
#| echo: true
#| cache: true
#| dependson: "python missing years read all reefs data 3"
#| code-fold: false
```

```{python}
#| label: python missing years all reefs temporal summary 3
#| results: markup
#| eval: false
#| echo: true
#| cache: true
#| code-fold: true
```

```{python}
#| label: python missing years all reefs temporal summary plot 3
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| code-fold: true
#| cache: true
```

#### 2. All sampled reefs

These data represent a simulated sampling design in which 25 fixed
(though randomly selected from among all the defined reefs in the
synthetic spatial domain) reefs are monitored over a continuous 12
year period.

![](../output/figures/Python_full_simple_raw_means_plot.png){width=500px}

```{python}
#| label: python missing years read sampled reefs data
#| results: markup
#| eval: true
#| echo: true
#| cache: false
```
```{python}
#| label: python missing years read sampled reefs data show
#| results: markup
#| eval: true
#| echo: true
#| cache: false
```

```{python}
#| label: python missing years sampled simple raw means
#| results: markup
#| eval: false
#| echo: true
#| code-fold: true
#| cache: false
```

```{python}
#| label: python missing years sampled simple raw means plot
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| code-fold: true
#| cache: false
#| dependson: "read sampled reefs data"
```

#### 3. Temporal gap in some reefs

These data represent the fixed 25 sites, however some of the reefs
have a temporal gap between years 2 and 6.

![](../output/figures/Python_sampled_reefs_3_plot.png){width=500px}
 
```{python}
#| label: python read sampled reefs data 3
#| results: markup
#| eval: true
#| echo: true
#| cache: false
```
```{python}
#| label: python read sampled reefs data 3 show
#| results: markup
#| eval: true
#| echo: true
#| cache: false
```

```{python}
#| label: python sampled reefs data 3 plot
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| code-fold: true
#| cache: false
#| dependson: "python read sampled reefs data 3 show"
```
 
#### 4. Temporal gap in all reefs

These data represent the fixed 25 sites, however all of the reefs
have a temporal gap between years 2 and 6.

![](../output/figures/Python_sampled_reefs_4_plot.png){width=500px}
 
```{python}
#| label: python read sampled reefs data 4
#| results: markup
#| eval: true
#| echo: true
#| cache: false
```
```{python}
#| label: python read sampled reefs data 4 show
#| results: markup
#| eval: true
#| echo: true
#| cache: false
```

```{python}
#| label: python sampled reefs data 4 plot
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| code-fold: true
#| cache: false
#| dependson: "python read sampled reefs data 3 show"
```
 
::::

:::

## Data preparations

Perform the following data preparation steps:

- specifically declare any categorical variables (as factors in R,
  categories in python)
- ensure that all levels of hierarchical (varying) effects have unique
  IDs
- express cover as a proportion out of 1 as is necessary for modelling
  against a beta distribution
- create a prediction grid containing all years in the monitoring
  range

::: {.panel-tabset}

### R

:::: {.panel-tabset}

#### All reefs

```{r}
#| label: sampled data prep
#| results: markup
#| eval: true
#| echo: true
#| cache: false
```
 
```{r}
#| label: newdata
#| results: markup
#| eval: true
#| echo: true
#| cache: false
```
 
```{r}
#| label: newdata b
#| results: markup
#| eval: true
#| echo: true
#| cache: false
```

#### All sampled reefs

```{r}
#| label: sampled data prep 0
#| results: markup
#| eval: true
#| echo: true
#| cache: false
```
```{r}
#| label: newdata 0
#| results: markup
#| eval: true
#| echo: true
#| cache: false
```


#### Temporal gap in some reefs

```{r}
#| label: sampled data prep 3
#| results: markup
#| eval: true
#| echo: true
#| cache: false
```

```{r}
#| label: newdata 3
#| results: markup
#| eval: true
#| echo: true
#| cache: false
```
 
```{r}
#| label: newdata 3b
#| results: markup
#| eval: true
#| echo: true
#| cache: false
```

#### Temporal gap in all reefs

```{r}
#| label: sampled data prep 4
#| results: markup
#| eval: true
#| echo: true
#| cache: false
```
```{r}
#| label: newdata 4
#| results: markup
#| eval: true
#| echo: true
#| cache: false
```

 
```{r}
#| label: newdata 4b
#| results: markup
#| eval: true
#| echo: true
#| cache: false
```

::::

### Python
    
:::: {.panel-tabset}

#### All reefs

```{python}
#| label: python benthos reefs
#| results: markup
#| eval: true
#| echo: true
#| cache: false
```

```{python}
#| label: python newdata
#| results: markup
#| eval: true
#| echo: true
#| cache: false
```

```{python}
#| label: python newdata b
#| results: markup
#| eval: true
#| echo: true
#| cache: false
```


#### All sampled reefs

```{python}
#| label: python missing years sampled data prep 0
#| results: markup
#| eval: true
#| echo: true
#| cache: false
```
```{python}
#| label: python missing years newdata 0
#| results: markup
#| eval: true
#| echo: true
#| cache: false
```

#### Temporal gap in some reefs

```{python}
#| label: python sampled data prep 3
#| results: markup
#| eval: true
#| echo: true
#| cache: false
```
```{python}
#| label: python newdata 3
#| results: markup
#| eval: true
#| echo: true
#| cache: false
```

#### Temporal gap in all reefs

```{python}
#| label: python sampled data prep 4
#| results: markup
#| eval: false
#| echo: true
#| cache: false
```
```{python}
#| label: python newdata 4
#| results: markup
#| eval: false
#| echo: true
#| cache: false
```

::::

:::

## Modelled trends

The following table lists datasets that are used in the comparison
figures along with their respective legend entries.

::: {.callout-note collapse=true}
### view table
| Dataset                          | Description                                                                       | Legend label(s)                       |
|----------------------------------|-----------------------------------------------------------------------------------|---------------------------------------|
| `benthos_reefs_sf`               | All reef-level data                                                               |                                       |
| `benthos_reefs_temporal_summary` | All global-level data                                                             | all mean / all median                 |
| `all_sampled_sum`                | Simple stats of all sampled data (25 sites)                                       | all_sampled_mean / all_sampled_median |
|                                  |                                                                                   |                                       |
| `benthos_fixed_locs_obs_0`       | All sampled data (25 sites)                                                       |                                       |
| `mod_glmmTMB_0`                  | glmmTMB model of all sampled data (25 sites)                                      |                                       |
| `glmmTMB_0_sum`                  | Estimated marginal means from all sampled data (25 sites)                         | glmmTMB                               |
| `mod_brms_0`                     | brms model of all sampled data (25 sites)                                         |                                       |
| `brms_0_sum`                     | Estimated marginal means from all sampled data (25 sites)                         | brms                                  |
| `mod_stan_0`                     | stan model of all sampled data (25 sites)                                         |                                       |
| `stan_0_sum`                     | Estimated marginal means from all sampled data (25 sites)                         | stan                                  |
| `mod_gbm_0`                      | gbm model of all sampled data (25 sites)                                          |                                       |
| `gbm_0_sum`                      | Estimated predictions from all sampled data (25 sites)                            | gbm                                   |
| `mod_gbm_0b`                     | gbm model with covariates of all sampled data (25 sites)                          |                                       |
| `gbm_0b_sum`                     | Estimated predictions with covariates from all sampled data (25 sites)            | gbm                                   |
| `gbm_0c_sum`                     | Estimated predictions with covariates from all sampled data (all sites)           | gbm                                   |
| `mod_dbarts_0`                   | bart model with covariates of all sampled ata (25 sites)                          |                                       |
| `dbarts_0_sum`                   | Estimated predictions from all sampled data (25 sites)                            | dbarts                                |
| `mod_dbarts_0b`                  | bart model with covariates of all sampled ata (25 sites)                          |                                       |
| `dbarts_0b_sum`                  | Estimated predictions with covariates from all sampled data (25 sites)            | dbarts                                |
| `dbarts_0c_sum`                  | Estimated predictions with covariates from all data (all sites)                   | dbarts                                |
|                                  |                                                                                   |                                       |
| `benthos_fixed_locs_obs_3`       | Gapped sampled data (25 sites)                                                  |                                       |
| `mod_glmmTMB_3`                  | glmmTMB model of gapped sampled data (25 sites)                                 |                                       |
| `glmmTMB_3_sum`                  | Estimated marginal means from gapped sampled data (25 sites)                    | glmmTMB                               |
| `mod_brms_3`                     | brms model of gapped sampled data (25 sites)                                    |                                       |
| `brms_3_sum`                     | Estimated marginal means from gapped sampled data (25 sites)                    | brms                                  |
| `mod_stan_3`                     | stan model of gapped sampled data (25 sites)                                    |                                       |
| `stan_3_sum`                     | Estimated marginal means from gapped sampled data (25 sites)                    | stan                                  |
| `mod_gbm_3`                      | gbm model of gapped sampled data (25 sites)                                     |                                       |
| `gbm_3_sum`                      | Estimated predictions from gapped sampled data (25 sites)                       | gbm                                   |
| `mod_gbm_3b`                     | gbm model with covariates of gapped sampled data (25 sites)                     |                                       |
| `gbm_3b_sum`                     | Estimated predictions with covariates from gapped sampled data (25 sites)       | gbm                                   |
| `gbm_3c_sum`                     | Estimated predictions with covariates from gapped sampled data (gapped sites) | gbm                                   |
| `mod_dbarts_3`                   | bart model with covariates of gapped sampled ata (25 sites)                     |                                       |
| `dbarts_3_sum`                   | Estimated predictions from gapped sampled data (25 sites)                       | dbarts                                |
| `mod_dbarts_3b`                  | bart model with covariates of gapped sampled ata (25 sites)                     |                                       |
| `dbarts_3b_sum`                  | Estimated predictions with covariates from gapped sampled data (25 sites)       | dbarts                                |
| `dbarts_3c_sum`                  | Estimated predictions with covariates from gapped data (all sites)              | dbarts                                |
|                                  |                                                                                   |                                       |
| `benthos_fixed_locs_obs_4`       | Gapped sampled data (all sites)                                                   |                                       |
| `mod_glmmTMB_4`                  | glmmTMB model of gapped sampled data (all sites)                                  |                                       |
| `glmmTMB_4_sum`                  | Estimated marginal means from gapped sampled data (all sites)                     | glmmTMB                               |
| `mod_brms_4`                     | brms model of gapped sampled data (all sites)                                     |                                       |
| `brms_4_sum`                     | Estimated marginal means from gapped sampled data (all sites)                     | brms                                  |
| `mod_stan_4`                     | stan model of gapped sampled data (all sites)                                     |                                       |
| `stan_4_sum`                     | Estimated marginal means from gapped sampled data (all sites)                     | stan                                  |
| `mod_gbm_4`                      | gbm model of gapped sampled data (all sites)                                      |                                       |
| `gbm_4_sum`                      | Estimated predictions from gapped sampled data (all sites)                        | gbm                                   |
| `mod_gbm_4b`                     | gbm model with covariates of gapped sampled data (all sites)                      |                                       |
| `gbm_4b_sum`                     | Estimated predictions with covariates from gapped sampled data (all sites)        | gbm                                   |
| `gbm_4c_sum`                     | Estimated predictions with covariates from gapped sampled data (gapped sites) | gbm                                   |
| `mod_dbarts_4`                   | bart model with covariates of gapped sampled ata (all sites)                      |                                       |
| `dbarts_4_sum`                   | Estimated predictions from gapped sampled data (all sites)                        | dbarts                                |
| `mod_dbarts_4b`                  | bart model with covariates of gapped sampled ata (all sites)                      |                                       |
| `dbarts_4b_sum`                  | Estimated predictions with covariates from gapped sampled data (all sites)        | dbarts                                |
| `dbarts_4c_sum`                  | Estimated predictions with covariates from gapped data (all sites)              | dbarts                                |

:::

Each of the sections below features a set of partial dependency plots.
These plots present the modelled temporal trends compared to a range
of other non-modelled estimates. The following table, defines each of
the trends presented throughout the partial plots. In the table,
**challenging data** refers to a dataset that has the focal modelling
challenge (for example, for the _Replace a reef_ issue, the
challenging data are observed data with a reef replacement.


| Trend                                                | Description                                                                       |
|------------------------------------------------------|-----------------------------------------------------------------------------------|
| `all mean`, `all median`, `true mean`, `true median` | Simple hierarchical means/medians for the full spatio-temporal grid (the "truth") |
| `all_sampled_ mean`, `all_sampled_ median`           | Simple hierarchical means/medians for the 25 sites / 12 years observational data  |
| `simple data mean`, `simple data median`             | Simple hierarchical means/medians for the **challenging data**                    |
| `glmmTMB`                                            | Modelled trends from a glmmTMB (frequentist) model                                |
| `brms`                                               | Modelled trends for a brms (Bayesian) model                                       |
| `stan`                                               | Modelled trends from a bespoke STAN (Bayesian) model                              |
| `gbm`                                                | Modelled trends from a Gradient Boosted Model (regression tree)                   |
| `dbarts`                                             | Modelled trends from a Bayesian Added Regression Tree                             |
|                                                      |                                                                                   |

Partial plots that display both a modelled trend as well as `simple
data mean` and `simple data median` allow us to compare how well the
model fits the training data.

Partial plots that display both a modelling trend as well as
`all_sampled_ mean`, `all_sampled_ median` and either `all mean`/`all
median` or `true mean`/`true median` allow us to compare the accuracy
of the model to both the full observed data and the full
spatio-temporal (truth) grid.


::: {.panel-tabset}


<!--
### All sampled reefs

:::: {.panel-tabset}

#### Data sets

:::::: {.panel-tabset .tabset-left}

##### benthos_fixed_locs_obs_3

These are the **data** used to **fit the model**

```{r}
#| label: glmmTMB_3 sample data
#| results: markup
#| eval: true
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "read sampled reefs data"
```

##### newdata_3

```{r}
#| label: glmmTMB_3 newdata 3
#| results: markup
#| eval: true
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "read sampled reefs data"
```
::::::

#### glmmTMB

```{r}
#| label: glmmTMB_0
#| results: markup
#| eval: false
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "read sampled reefs data"
```

::::: {.panel-tabset}

##### Partial dependency plot

```{r}
#| label: glmmTMB_0_emmeans
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

```{r}
#| label: glmmTMB_0_emmeans plot
#| eval: false
#| results: markup
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| code-fold: true
#| cache: true
#| dependson: "glmmTMB_0"
```

![](../output/figures/R_pdp_mod_glmmTMB_0.png){width=700px}

- sampled reefs (blue and green dashed lines) are lower than the true
  global average (red and khaki)
- glmmTMB modelled estimates are consistent with the 25 site same
  data, yet biased lower than the "truth"

##### Model Validation

```{r}
#| label: glmmTMB_0_dharma
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| cache: false
#| code-fold: true
```

```{r}
#| label: glmmTMB_0_dharma plot
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 4
#| code-fold: true
#| cache: true
#| dependson: "glmmTMB_0"
```

![](../output/figures/R_dharma_mod_glmmTMB_0.png){width=500px}

##### Summary

```{r}
#| label: glmmTMB_0_summary
#| results: markup
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "glmmTMB_0"
mod_glmmTMB_0 <- readRDS(
  file = paste0(data_path, "synthetic/mod_glmmTMB_0.rds")
)
mod_glmmTMB_0 |> summary()
```

:::::

#### brms

```{r}
#| label: brms_pre_0
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

```{r}
#| label: brms_0
#| results: markup
#| eval: false
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "read sampled reefs data"
```

::::: {.panel-tabset}
##### Partial dependency plot

```{r}
#| label: brms_0_emmeans
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
```{r}
#| label: brms_0_emmeans plot
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| code-fold: true
#| cache: true
#| dependson: "brms_0"
```

![](../output/figures/R_pdp_mod_brms_0.png){width=700px}

- sampled reefs (blue and green dashed lines) are lower than the true
  global average (red and khaki)
- brms modelled estimates are consistent with the 25 site same
  data, yet biased lower than the "truth"

##### Sampling diagnostics

:::::: {.panel-tabset}

###### Traceplots

```{r}
#| label: brms_trace_0
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "brms_0"
```

![](../output/figures/R_brms_trace_0.png){width=500px}

###### Autocorrelation plots

```{r}
#| label: brms_ac_0
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "brms_0"
```

![](../output/figures/R_brms_ac_0.png){width=500px}

###### Rhat

```{r}
#| label: brms_rhat_0
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "brms_0"
```

![](../output/figures/R_brms_rhat_0.png){width=500px}

###### Effective sample size

```{r}
#| label: brms_ess_0
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "brms_0"
```

![](../output/figures/R_brms_ess_0.png){width=500px}

::::::

##### Model validation

```{r}
#| label: brms_ppc_0
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| code-fold: true
#| cache: true
#| dependson: "brms_0"
```

![](../output/figures/R_brms_ppc_0.png){width=500px}

##### Summary

```{r}
#| label: brms_0_summary
#| results: markup
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "brms_0"
mod_brms_0 <- readRDS(
  file = paste0(data_path, "synthetic/mod_brms_0.rds")
)
mod_brms_0 |> summary()
```

:::::

#### stan

```{r}
#| label: stan_pre_0
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

```{r}
#| label: stan_0
#| results: markup
#| eval: false
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "read sampled reefs data"
```

::::: {.panel-tabset}

##### Partial dependency plot

```{r}
#| label: stan_0_pdp
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

```{r}
#| label: stan_0_pdp plot
#| results: markup
#| echo: true
#| eval: false
#| fig-width: 8
#| fig-height: 6
#| code-fold: true
#| cache: true
#| dependson: "stan_0"
```

![](../output/figures/R_pdp_mod_stan_0.png){width=700px}

- sampled reefs (blue and green dashed lines) are lower than the true
  global average (red and khaki)
- stan modelled estimates are consistent with the 25 site same
  data, yet biased lower than the "truth"

##### Sampling diagnostics

:::::: {.panel-tabset}

###### Traceplots

```{r}
#| label: stan_trace_0
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "stan_0"
```

![](../output/figures/R_stan_trace_0.png){width=500px}

###### Autocorrelation plots

```{r}
#| label: stan_ac_0
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "stan_0"
```

![](../output/figures/R_stan_ac_0.png){width=500px}

###### Rhat

```{r}
#| label: stan_rhat_0
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "stan_0"
```

![](../output/figures/R_stan_rhat_0.png){width=500px}

###### Effective sample size

```{r}
#| label: stan_ess_0
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "stan_0"
```

![](../output/figures/R_stan_ess_0.png){width=500px}

::::::

##### Model validation

```{r}
#| label: stan_ppc_0
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| code-fold: true
#| cache: true
#| dependson: "stan_0"
```

![](../output/figures/R_stan_ppc_0.png){width=500px}

##### Summary

```{r}
#| label: stan_0_summary
#| results: markup
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "stan_0"
mod_stan_0 <- readRDS(
  file = paste0(data_path, "synthetic/mod_stan_0.rds")
)
mod_stan_0$print(
  variables = c("phi", "beta", "sd_1", "sd_2", "sd_3"),
  max_rows = 20
)
mod_stan_0$print(
  variables = "cellmeans",
  max_rows = 20
)
```

:::::

#### GBM

```{r}
#| label: gbm_0
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

```{r}
#| label: gbm_post_0
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

::::: {.panel-tabset}

##### Partial dependency plot

```{r}
#| label: gbm_pdp_0
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
```{r}
#| label: pdp_gbm_0_plot_
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| cache: false
#| code-fold: true
```

![](../output/figures/R_pdp_mod_gbm_0.png){width=700px}

- sampled reefs (blue and green dashed lines) are lower than the true
  global average (red and khaki)
- gbm modelled estimates are consistent with the 25 site same
  data, yet biased lower than the "truth"
- gbm derived predictions lack uncertainty estimates

:::::

#### GBM + covariates

```{r}
#| label: gbm_0b
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

```{r}
#| label: gbm_post_0b
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

::::: {.panel-tabset}

##### Partial dependency plot (sample data only)

```{r}
#| label: gbm_pdp_0b
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
```{r}
#| label: pdp_pdp_0b plot
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| cache: false
#| code-fold: true
```

![](../output/figures/R_pdp_mod_gbm_0b.png){width=700px}
![](../output/figures/R_infl_mod_gbm_0b.png){width=700px}

- sampled reefs (blue and green dashed lines) are lower than the true
  global average (red and khaki)
- gbm modelled estimates are consistent with the 25 site same
  data, yet biased lower than the "truth"
- gbm derived predictions lack uncertainty estimates
- relative influences mainly space/time


##### Partial dependency plot (full domain)

```{r}
#| label: gbm_pdp_0c
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
```{r}
#| label: pdp_pdp_0c plot
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| cache: false
#| code-fold: true
```

![](../output/figures/R_pdp_mod_gbm_0c.png){width=700px}
![](../output/figures/R_infl_mod_gbm_0c.png){width=700px}

- sampled reefs (blue and green dashed lines) are lower than the true
  global average (red and khaki)
- gbm modelled estimates are consistent with the 25 site same
  data, yet biased lower than the "truth"
- gbm derived predictions lack uncertainty estimates
- relative influences mainly space/time

:::::

#### dbarts

```{r}
#| label: dbarts_0
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

::::: {.panel-tabset}

##### Partial dependency plot

```{r}
#| label: dbarts_pdp_0
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
```{r}
#| label: dbarts_0_pdp plot
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| cache: false
#| code-fold: true
```

![](../output/figures/R_pdp_mod_dbarts_0.png){width=700px}

- sampled reefs (blue and green dashed lines) are lower than the true
  global average (red and khaki)
- gbm modelled estimates are consistent with the 25 site same
  data, yet biased lower than the "truth"
- gbm derived predictions lack uncertainty estimates

:::::

#### dbarts + covariates

```{r}
#| label: dbarts_0b
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

::::: {.panel-tabset}

##### Partial dependency plot (sample data only)

```{r}
#| label: dbarts_pdp_0b
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
```{r}
#| label: dbarts_0b_pdp plot
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| cache: false
#| code-fold: true
```

![](../output/figures/R_pdp_mod_dbarts_0b.png){width=700px}

- sampled reefs (blue and green dashed lines) are lower than the true
  global average (red and khaki)
- dbarts modelled estimates are consistent with the 25 site same
  data, yet biased lower than the "truth"

##### Partial dependency plot (full domain)

```{r}
#| label: dbarts_pdp_0c
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
```{r}
#| label: dbarts_0c_pdp plot
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| cache: false
#| code-fold: true
```

![](../output/figures/R_pdp_mod_dbarts_0c.png){width=700px}

- sampled reefs (blue and green dashed lines) are lower than the true
  global average (red and khaki)
- dbarts modelled estimates are slightly elevated above the 25 site same
  data, yet still biased lower than the "truth"

:::::

#### pymc-bart + covariates

```{python}
#| label: python missing years sampled data barts data 0
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

```{python}
#| label: python missing years sampled data barts fit 0
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
::::: {.panel-tabset}

##### Partial dependency plot (sample data only)

![](../output/figures/python_pdp_pymc_bart_0b.png){width=700px}
 
```{python}
#| label: python missing years sampled data barts prep plot 0c
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
```{python}
#| label: python missing years sampled data barts plot 0c
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

##### Partial dependency plot (full domain)

![](../output/figures/python_pdp_pymc_bart_0c.png){width=700px}

```{python}
#| label: python missing years sampled data barts prep plot 0c
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
```{python}
#| label: python missing years sampled data barts plot 0c
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

:::::

::::

-->

### Temporal gap in some reefs

:::: {.panel-tabset}


#### Data sets

:::::: {.panel-tabset .tabset-left}

##### benthos_fixed_locs_obs_3

These are the **data** used to **fit the model**

```{r}
#| label: glmmTMB_3 sample data
#| results: markup
#| eval: true
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "read sampled reefs data"
```

##### newdata_3

These are the **sampled years** for calculating marginal means to year level

```{r}
#| label: glmmTMB_3 newdata 3
#| results: markup
#| eval: true
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "read sampled reefs data"
```
##### newdata_3b

These are the **sampled data** used to predict the sampled data to reef/year level from **models without covariates**

```{r}
#| label: glmmTMB_3 newdata 3b
#| results: markup
#| eval: true
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "read sampled reefs data"
```

##### newdata

These are the **full data years** used for calculating marginal means to year level

```{r}
#| label: glmmTMB_3 newdata
#| results: markup
#| eval: true
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "read sampled reefs data"
```
##### newdata_b

These are the **full data** used to predict the full data to reef/year level from **all models**

```{r}
#| label: glmmTMB_3 newdata_b
#| results: markup
#| eval: true
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "read sampled reefs data"
```
::::::

#### glmmTMB

```{r}
#| label: glmmTMB_3
#| results: markup
#| eval: false
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "read sampled reefs data"
```

::::: {.panel-tabset}

##### Partial dependency plot

:::::: {.panel-tabset}

###### Sampled reefs
::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_1_mod_glmmTMB_3.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: glmmTMB_3_pred_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- glmmTMB modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **Sampled reefs**
```{r}
#| label: glmmTMB_3_mse_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

###### All reefs

::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_2_mod_glmmTMB_3.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: glmmTMB_3_pred_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- glmmTMB modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **All reefs**

```{r}
#| label: glmmTMB_3_mse_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

::::::


```{r}
#| label: glmmTMB_3_emmeans
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

```{r}
#| label: glmmTMB_3_emmeans plot
#| eval: false
#| results: markup
#| echo: true
#| fig-width: 12
#| fig-height: 6
#| code-fold: true
#| cache: true
#| dependson: "glmmTMB_3"
```

![](../output/figures/R_pdp_mod_glmmTMB_3.png){width=900px}

- left figure compares glmmTMB modelled estimates to the sample data
- right figure compares glmmTMB modelled estimates to the simple
  hierarchical sampled means/medians and the true means/medians
- sampled reefs (blue and khaki dashed lines) are lower than the true
  global average (blue and purple) - right side figure
- glmmTMB modelled estimates are consistent with the 25 site,
  replacement data, yet biased lower than the "truth"

##### Model Validation

```{r}
#| label: glmmTMB_3_dharma
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| cache: false
#| code-fold: true
```

```{r}
#| label: glmmTMB_3_dharma plot
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 4
#| code-fold: true
#| cache: true
#| dependson: "glmmTMB_3"
```

![](../output/figures/R_dharma_mod_glmmTMB_3.png){width=500px}

##### Summary

```{r}
#| label: glmmTMB_3_summary
#| results: markup
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "glmmTMB_3"
mod_glmmTMB_3 <- readRDS(
  file = paste0(data_path, "synthetic/mod_glmmTMB_3.rds")
)
mod_glmmTMB_3 |> summary()
```

:::::


#### glmmTMB + coveriates


```{r}
#| label: glmmTMB_3b
#| results: markup
#| eval: false
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "read sampled reefs data"
```

::::: {.panel-tabset}

##### Partial dependency plot

:::::: {.panel-tabset}

###### Sampled reefs
::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_1_mod_glmmTMB_3b.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: glmmTMB_3b_pred_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
   
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- glmmTMB modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **Sampled reefs**
```{r}
#| label: glmmTMB_3b_mse_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

###### All reefs

::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_2_mod_glmmTMB_3b.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: glmmTMB_3b_pred_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- glmmTMB modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **All reefs**

```{r}
#| label: glmmTMB_3b_mse_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

::::::

##### Model Validation

```{r}
#| label: glmmTMB_3b_dharma
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| cache: false
#| code-fold: true
```

```{r}
#| label: glmmTMB_3b_dharma plot
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 4
#| code-fold: true
#| cache: true
#| dependson: "glmmTMB_3"
```

![](../output/figures/R_dharma_mod_glmmTMB_3b.png){width=500px}

##### Summary

```{r}
#| label: glmmTMB_3b_summary
#| results: markup
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "glmmTMB_3b"
mod_glmmTMB_3b <- readRDS(
  file = paste0(data_path, "synthetic/mod_glmmTMB_3b.rds")
)
mod_glmmTMB_3b |> summary()
```

:::::

 
#### brms

```{r}
#| label: brms_pre_3
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

```{r}
#| label: brms_3
#| results: markup
#| eval: false
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "read sampled reefs data"
```

::::: {.panel-tabset}

##### Partial dependency plot

:::::: {.panel-tabset}

###### Sampled reefs
::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_1_mod_brms_3.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: brms_3_pred_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- brms modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **Sampled reefs**
```{r}
#| label: brms_3_mse_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

###### All reefs

::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_2_mod_brms_3.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: brms_3_pred_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- brms modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **All reefs**

```{r}
#| label: brms_3_mse_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

::::::

##### Sampling diagnostics

:::::: {.panel-tabset}

###### Traceplots

```{r}
#| label: brms_trace_3
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "brms_3"
```

![](../output/figures/R_brms_trace_3.png){width=500px}

###### Autocorrelation plots

```{r}
#| label: brms_ac_3
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "brms_3"
```

![](../output/figures/R_brms_ac_3.png){width=500px}

###### Rhat

```{r}
#| label: brms_rhat_3
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "brms_3"
```

![](../output/figures/R_brms_rhat_3.png){width=500px}

###### Effective sample size

```{r}
#| label: brms_ess_3
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "brms_3"
```

![](../output/figures/R_brms_ess_3.png){width=500px}

::::::

##### Model validation

```{r}
#| label: brms_ppc_3
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| code-fold: true
#| cache: true
#| dependson: "brms_3"
```

![](../output/figures/R_brms_ppc_3.png){width=500px}

##### Summary

```{r}
#| label: brms_3_summary
#| results: markup
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "brms_3"
mod_brms_3 <- readRDS(
  file = paste0(data_path, "synthetic/mod_brms_3.rds")
)
mod_brms_3 |> summary()
```

:::::

#### brms + covariates

```{r}
#| label: brms_pre_3b
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

```{r}
#| label: brms_3b
#| results: markup
#| eval: false
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "read sampled reefs data"
```

::::: {.panel-tabset}

##### Partial dependency plot

:::::: {.panel-tabset}

###### Sampled reefs
::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_1_mod_brms_3b.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: brms_3b_pred_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- brms modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **Sampled reefs**
```{r}
#| label: brms_3b_mse_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

###### All reefs

::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_2_mod_brms_3b.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: brms_3b_pred_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- brms modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **All reefs**

```{r}
#| label: brms_3b_mse_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

::::::

##### Sampling diagnostics

:::::: {.panel-tabset}

###### Traceplots

```{r}
#| label: brms_trace_3b
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "brms_3b"
```

![](../output/figures/R_brms_trace_3b.png){width=500px}

###### Autocorrelation plots

```{r}
#| label: brms_ac_3b
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "brms_3b"
```

![](../output/figures/R_brms_ac_3b.png){width=500px}

###### Rhat

```{r}
#| label: brms_rhat_3b
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "brms_3b"
```

![](../output/figures/R_brms_rhat_3b.png){width=500px}

###### Effective sample size

```{r}
#| label: brms_ess_3b
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "brms_3b"
```

![](../output/figures/R_brms_ess_3b.png){width=500px}

::::::

##### Model validation

```{r}
#| label: brms_ppc_3b
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| code-fold: true
#| cache: true
#| dependson: "brms_3b"
```

![](../output/figures/R_brms_ppc_3b.png){width=500px}

##### Summary

```{r}
#| label: brms_3b_summary
#| results: markup
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "brms_3b"
mod_brms_3b <- readRDS(
  file = paste0(data_path, "synthetic/mod_brms_3b.rds")
)
mod_brms_3b |> summary()
```

:::::


#### stan

```{r}
#| label: stan_pre_3
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

```{r}
#| label: stan_3
#| results: markup
#| eval: false
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "read sampled reefs data"
```

::::: {.panel-tabset}

##### Partial dependency plot

:::::: {.panel-tabset}

###### Sampled reefs
::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_1_mod_stan_3.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: stan_3_pred_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- stan modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **Sampled reefs**
```{r}
#| label: stan_3_mse_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

###### All reefs

::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_2_mod_stan_3.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: stan_3_pred_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- stan modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **All reefs**

```{r}
#| label: stan_3_mse_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

::::::

##### Sampling diagnostics

:::::: {.panel-tabset}

###### Traceplots

```{r}
#| label: stan_trace_3
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "stan_3"
```

![](../output/figures/R_stan_trace_3.png){width=500px}

###### Autocorrelation plots

```{r}
#| label: stan_ac_3
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "stan_3"
```

![](../output/figures/R_stan_ac_3.png){width=500px}

###### Rhat

```{r}
#| label: stan_rhat_3
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "stan_3"
```

![](../output/figures/R_stan_rhat_3.png){width=500px}

###### Effective sample size

```{r}
#| label: stan_ess_3
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "stan_3"
```

![](../output/figures/R_stan_ess_3.png){width=500px}

::::::

##### Model validation

```{r}
#| label: stan_ppc_3
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| code-fold: true
#| cache: true
#| dependson: "stan_3"
```

![](../output/figures/R_stan_ppc_3.png){width=500px}

##### Summary

```{r}
#| label: stan_3_summary
#| results: markup
#| eval: true
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "stan_3"
mod_stan_3 <- readRDS(
  file = paste0(data_path, "synthetic/mod_stan_3.rds")
)

mod_stan_3$print(
  variables = c("phi", "beta", "sd_1", "sd_2", "sd_3"),
  max_rows = 20
)
mod_stan_3$print(
  variables = "cellmeans",
  max_rows = 20
)
```

:::::


#### GBM

```{r}
#| label: gbm_3
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

```{r}
#| label: gbm_post_3
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

::::: {.panel-tabset}

##### Partial dependency plot

:::::: {.panel-tabset}

###### Sampled reefs
::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_1_mod_gbm_3.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: gbm_3_pred_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- gbm modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **Sampled reefs**
```{r}
#| label: gbm_3_mse_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

###### All reefs

::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_2_mod_gbm_3.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: gbm_3_pred_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- gbm modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **All reefs**

```{r}
#| label: gbm_3_mse_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

::::::

:::::


#### GBM + covariates

```{r}
#| label: gbm_3b
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

```{r}
#| label: gbm_post_3b
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

::::: {.panel-tabset}

##### Partial dependency plot

:::::: {.panel-tabset}

###### Sampled reefs
::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_1_mod_gbm_3b.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: gbm_3b_pred_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- gbm modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **Sampled reefs**
```{r}
#| label: gbm_3b_mse_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

###### All reefs

::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_2_mod_gbm_3b.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: gbm_3b_pred_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- gbm modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **All reefs**

```{r}
#| label: gbm_3b_mse_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

::::::

:::::

#### dbarts

```{r}
#| label: dbarts_3
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

::::: {.panel-tabset}

##### Partial dependency plot

:::::: {.panel-tabset}

###### Sampled reefs
::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_1_mod_dbarts_3.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: dbarts_3_pred_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- dbarts modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **Sampled reefs**
```{r}
#| label: dbarts_3_mse_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

###### All reefs

::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_2_mod_dbarts_3.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: dbarts_3_pred_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- dbarts modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **All reefs**

```{r}
#| label: dbarts_3_mse_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

::::::

:::::



#### dbarts + covariates

```{r}
#| label: dbarts_3b
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

::::: {.panel-tabset}

##### Partial dependency plot

:::::: {.panel-tabset}

###### Sampled reefs
::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_1_mod_dbarts_3b.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: dbarts_3b_pred_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- dbarts modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **Sampled reefs**
```{r}
#| label: dbarts_3b_mse_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

###### All reefs

::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_2_mod_dbarts_3b.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: dbarts_3b_pred_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- dbarts modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **All reefs**

```{r}
#| label: dbarts_3b_mse_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

:::::

::::

#### xgboost + covariates

```{r}
#| label: xgboost_3b
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

::::: {.panel-tabset}

##### Partial dependency plot

:::::: {.panel-tabset}

###### Sampled reefs
::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_1_mod_xgboost_3b.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: xgboost_3b_pred_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- xgboost modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **Sampled reefs**
```{r}
#| label: xgboost_3b_mse_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

###### All reefs

::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_2_mod_xgboost_3b.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: xgboost_3b_pred_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- xgboost modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **All reefs**

```{r}
#| label: xgboost_3b_mse_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

:::::

::::

#### pymc-bart + covariates

```{python}
#| label: python sampled data barts data 3
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

```{python}
#| label: python sampled data barts fit 3
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

::::: {.panel-tabset}

##### Partial dependency plot (sample data only)

:::::: {.panel-tabset}

###### Sampled reefs
::: {.columns}
:::: {.column width="50%"}
![](../output/figures/python_pdp_pymc_bart_3b.png){width=350px}
::::
:::: {.column width="50%"}
```{python}
#| label: python sampled data barts prep plot 3
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
```{python}
#| label: python sampled data barts plot 3
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- pymc-barts modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **Sampled reefs**
```{python}
#| label: python sampled data pymc_barts mse 3b 1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

###### All reefs

::: {.columns}
:::: {.column width="50%"}
![](../output/figures/python_pdp_pymc_bart_3c.png){width=350px}
::::
:::: {.column width="50%"}
```{python}
#| label: python sampled data barts prep plot 3c
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
```{python}
#| label: python sampled data barts plot 3c
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- pymc-barts modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **All reefs**

```{python}
#| label: python sampled data pymc_barts mse 3b 2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```


:::::

::::

#### Comparisons
     
```{r}
#| label: comparison_3
#| results: markup
#| eval: false
#| echo: true
#| code-fold: true
#| cache: false
```
 
::: {#fig-mse_3_1}
![](../output/figures/mse_3_1.png){width=800px}

Mean square error (MSE) of models build on Northern reefs data (25
reefs) and compared to either reef/year level data. This represents
the models' ability to represent median-scale spatio-temporal
patterns. Smaller values imply smaller error since predicted values
are closer to the observed values. Panel columns condition MSE into
predicting data from either all Northern reefs, all Southern reefs or
only the sampled Northern reefs. Panel rows condition MSE into whether
models contained covariates or not.

:::

::: {#fig-mse_3_2}
![](../output/figures/mse_3_2.png){width=800px}

Mean inaccuracy (%) of models build on Northern reefs data (25
reefs) and compared to either reef/year level data. This represents
the models' ability to represent median-scale spatio-temporal
patterns. Smaller values imply smaller inaccuracy since predicted values
are closer to the observed values. Panel columns condition MSE into
predicting data from either all Northern reefs, all Southern reefs or
only the sampled Northern reefs. Panel rows condition MSE into whether
models contained covariates or not.

:::

```{r}
#| label: comparison_3_tab
#| results: markup
#| eval: true
#| echo: true
#| code-fold: true
#| cache: false
comps_3 <- readRDS(file = paste0(data_path,
                                        "synthetic/comps_3.rds")
                          ) 
comps_3 |> knitr::kable()
```
      
::::
 
### Temporal gap in all reefs

:::: {.panel-tabset}


#### Data sets

:::::: {.panel-tabset .tabset-left}

##### benthos_fixed_locs_obs_4

These are the **data** used to **fit the model**

```{r}
#| label: glmmTMB_4 sample data
#| results: markup
#| eval: true
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "read sampled reefs data"
```

##### newdata_4

These are the **sampled years** for calculating marginal means to year level

```{r}
#| label: glmmTMB_4 newdata 4
#| results: markup
#| eval: true
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "read sampled reefs data"
```

##### newdata_4b

These are the **sampled data** used to predict the sampled data to reef/year level from **models without covariates**

```{r}
#| label: glmmTMB_4 newdata 4b
#| results: markup
#| eval: true
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "read sampled reefs data"
```

##### newdata

These are the **full data years** used for calculating marginal means to year level

```{r}
#| label: glmmTMB_3 newdata
#| results: markup
#| eval: true
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "read sampled reefs data"
```
##### newdata_b

These are the **full data** used to predict the full data to reef/year level from **all models**

```{r}
#| label: glmmTMB_3 newdata_b
#| results: markup
#| eval: true
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "read sampled reefs data"
```
::::::


#### glmmTMB

```{r}
#| label: glmmTMB_4
#| results: markup
#| eval: false
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "read sampled reefs data"
```

::::: {.panel-tabset}

##### Partial dependency plot

:::::: {.panel-tabset}

###### Sampled reefs
::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_1_mod_glmmTMB_4.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: glmmTMB_4_pred_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- glmmTMB modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **Sampled reefs**
```{r}
#| label: glmmTMB_4_mse_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

###### All reefs

::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_2_mod_glmmTMB_4.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: glmmTMB_4_pred_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- glmmTMB modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **All reefs**

```{r}
#| label: glmmTMB_4_mse_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

::::::


```{r}
#| label: glmmTMB_4_emmeans
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

```{r}
#| label: glmmTMB_4_emmeans plot
#| eval: false
#| results: markup
#| echo: true
#| fig-width: 12
#| fig-height: 6
#| code-fold: true
#| cache: true
#| dependson: "glmmTMB_4"
```

![](../output/figures/R_pdp_mod_glmmTMB_4.png){width=900px}

- left figure compares glmmTMB modelled estimates to the sample data
- right figure compares glmmTMB modelled estimates to the simple
  hierarchical sampled means/medians and the true means/medians
- sampled reefs (blue and khaki dashed lines) are lower than the true
  global average (blue and purple) - right side figure
- glmmTMB modelled estimates are consistent with the 25 site,
  replacement data, yet biased lower than the "truth"

##### Model Validation

```{r}
#| label: glmmTMB_4_dharma
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| cache: false
#| code-fold: true
```

```{r}
#| label: glmmTMB_4_dharma plot
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 4
#| code-fold: true
#| cache: true
#| dependson: "glmmTMB_4"
```

![](../output/figures/R_dharma_mod_glmmTMB_4.png){width=500px}

##### Summary

```{r}
#| label: glmmTMB_4_summary
#| results: markup
#| eval: true
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "glmmTMB_4"
mod_glmmTMB_4 <- readRDS(
  file = paste0(data_path, "synthetic/mod_glmmTMB_4.rds")
)
mod_glmmTMB_4 |> summary()
```

:::::


#### glmmTMB + coveriates


```{r}
#| label: glmmTMB_4b
#| results: markup
#| eval: false
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "read sampled reefs data"
```

::::: {.panel-tabset}

##### Partial dependency plot

:::::: {.panel-tabset}

###### Sampled reefs
::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_1_mod_glmmTMB_4b.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: glmmTMB_4b_pred_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
   
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- glmmTMB modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **Sampled reefs**
```{r}
#| label: glmmTMB_4b_mse_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

###### All reefs

::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_2_mod_glmmTMB_4b.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: glmmTMB_4b_pred_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- glmmTMB modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **All reefs**

```{r}
#| label: glmmTMB_4b_mse_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

::::::

##### Model Validation

```{r}
#| label: glmmTMB_4b_dharma
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| cache: false
#| code-fold: true
```

```{r}
#| label: glmmTMB_4b_dharma plot
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 4
#| code-fold: true
#| cache: true
#| dependson: "glmmTMB_4"
```

![](../output/figures/R_dharma_mod_glmmTMB_4b.png){width=500px}

##### Summary

```{r}
#| label: glmmTMB_4b_summary
#| results: markup
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "glmmTMB_4b"
mod_glmmTMB_4b <- readRDS(
  file = paste0(data_path, "synthetic/mod_glmmTMB_4b.rds")
)
mod_glmmTMB_4b |> summary()
```

:::::

 
#### brms

```{r}
#| label: brms_pre_4
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

```{r}
#| label: brms_4
#| results: markup
#| eval: false
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "read sampled reefs data"
```

::::: {.panel-tabset}

##### Partial dependency plot

:::::: {.panel-tabset}

###### Sampled reefs
::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_1_mod_brms_4.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: brms_4_pred_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- brms modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **Sampled reefs**
```{r}
#| label: brms_4_mse_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

###### All reefs

::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_2_mod_brms_4.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: brms_4_pred_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- brms modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **All reefs**

```{r}
#| label: brms_4_mse_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

::::::

##### Sampling diagnostics

:::::: {.panel-tabset}

###### Traceplots

```{r}
#| label: brms_trace_4
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "brms_4"
```

![](../output/figures/R_brms_trace_4.png){width=500px}

###### Autocorrelation plots

```{r}
#| label: brms_ac_4
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "brms_4"
```

![](../output/figures/R_brms_ac_4.png){width=500px}

###### Rhat

```{r}
#| label: brms_rhat_4
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "brms_4"
```

![](../output/figures/R_brms_rhat_4.png){width=500px}

###### Effective sample size

```{r}
#| label: brms_ess_4
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "brms_4"
```

![](../output/figures/R_brms_ess_4.png){width=500px}

::::::

##### Model validation

```{r}
#| label: brms_ppc_4
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| code-fold: true
#| cache: true
#| dependson: "brms_4"
```

![](../output/figures/R_brms_ppc_4.png){width=500px}

##### Summary

```{r}
#| label: brms_4_summary
#| results: markup
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "brms_4"
mod_brms_4 <- readRDS(
  file = paste0(data_path, "synthetic/mod_brms_4.rds")
)
mod_brms_4 |> summary()
```

:::::

#### brms + covariates

```{r}
#| label: brms_pre_4b
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

```{r}
#| label: brms_4b
#| results: markup
#| eval: false
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "read sampled reefs data"
```

::::: {.panel-tabset}

##### Partial dependency plot

:::::: {.panel-tabset}

###### Sampled reefs
::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_1_mod_brms_4b.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: brms_4b_pred_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- brms modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **Sampled reefs**
```{r}
#| label: brms_4b_mse_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

###### All reefs

::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_2_mod_brms_4b.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: brms_4b_pred_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- brms modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **All reefs**

```{r}
#| label: brms_4b_mse_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

::::::

##### Sampling diagnostics

:::::: {.panel-tabset}

###### Traceplots

```{r}
#| label: brms_trace_4b
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "brms_4b"
```

![](../output/figures/R_brms_trace_4b.png){width=500px}

###### Autocorrelation plots

```{r}
#| label: brms_ac_4b
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "brms_4b"
```

![](../output/figures/R_brms_ac_4b.png){width=500px}

###### Rhat

```{r}
#| label: brms_rhat_4b
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "brms_4b"
```

![](../output/figures/R_brms_rhat_4b.png){width=500px}

###### Effective sample size

```{r}
#| label: brms_ess_4b
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "brms_4b"
```

![](../output/figures/R_brms_ess_4b.png){width=500px}

::::::

##### Model validation

```{r}
#| label: brms_ppc_4b
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| code-fold: true
#| cache: true
#| dependson: "brms_4b"
```

![](../output/figures/R_brms_ppc_4b.png){width=500px}

##### Summary

```{r}
#| label: brms_4b_summary
#| results: markup
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "brms_4b"
mod_brms_4b <- readRDS(
  file = paste0(data_path, "synthetic/mod_brms_4b.rds")
)
mod_brms_4b |> summary()
```

:::::


#### stan

```{r}
#| label: stan_pre_4
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

```{r}
#| label: stan_4
#| results: markup
#| eval: false
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "read sampled reefs data"
```

::::: {.panel-tabset}

##### Partial dependency plot

:::::: {.panel-tabset}

###### Sampled reefs
::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_1_mod_stan_4.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: stan_4_pred_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- stan modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **Sampled reefs**
```{r}
#| label: stan_4_mse_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

###### All reefs

::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_2_mod_stan_4.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: stan_4_pred_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- stan modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **All reefs**

```{r}
#| label: stan_4_mse_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

::::::

##### Sampling diagnostics

:::::: {.panel-tabset}

###### Traceplots

```{r}
#| label: stan_trace_4
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "stan_4"
```

![](../output/figures/R_stan_trace_4.png){width=500px}

###### Autocorrelation plots

```{r}
#| label: stan_ac_4
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "stan_4"
```

![](../output/figures/R_stan_ac_4.png){width=500px}

###### Rhat

```{r}
#| label: stan_rhat_4
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "stan_4"
```

![](../output/figures/R_stan_rhat_4.png){width=500px}

###### Effective sample size

```{r}
#| label: stan_ess_4
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "stan_4"
```

![](../output/figures/R_stan_ess_4.png){width=500px}

::::::

##### Model validation

```{r}
#| label: stan_ppc_4
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| code-fold: true
#| cache: true
#| dependson: "stan_4"
```

![](../output/figures/R_stan_ppc_4.png){width=500px}

##### Summary

```{r}
#| label: stan_4_summary
#| results: markup
#| eval: true
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "stan_4"
mod_stan_4 <- readRDS(
  file = paste0(data_path, "synthetic/mod_stan_4.rds")
)

mod_stan_4$print(
  variables = c("phi", "beta", "sd_1", "sd_2", "sd_3"),
  max_rows = 20
)
mod_stan_4$print(
  variables = "cellmeans",
  max_rows = 20
)
```

:::::

#### GBM

```{r}
#| label: gbm_4
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

```{r}
#| label: gbm_post_4
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

::::: {.panel-tabset}

##### Partial dependency plot

:::::: {.panel-tabset}

###### Sampled reefs
::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_1_mod_gbm_4.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: gbm_4_pred_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- gbm modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **Sampled reefs**
```{r}
#| label: gbm_4_mse_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

###### All reefs

::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_2_mod_gbm_4.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: gbm_4_pred_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- gbm modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **All reefs**

```{r}
#| label: gbm_4_mse_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

::::::

:::::


#### GBM + covariates

```{r}
#| label: gbm_4b
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

```{r}
#| label: gbm_post_4b
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

::::: {.panel-tabset}

##### Partial dependency plot

:::::: {.panel-tabset}

###### Sampled reefs
::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_1_mod_gbm_4b.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: gbm_4b_pred_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- gbm modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **Sampled reefs**
```{r}
#| label: gbm_4b_mse_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

###### All reefs

::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_2_mod_gbm_4b.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: gbm_4b_pred_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- gbm modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **All reefs**

```{r}
#| label: gbm_4b_mse_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

::::::

:::::

#### dbarts

```{r}
#| label: dbarts_4
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

::::: {.panel-tabset}

##### Partial dependency plot

:::::: {.panel-tabset}

###### Sampled reefs
::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_1_mod_dbarts_4.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: dbarts_4_pred_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- dbarts modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **Sampled reefs**
```{r}
#| label: dbarts_4_mse_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

###### All reefs

::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_2_mod_dbarts_4.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: dbarts_4_pred_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- dbarts modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **All reefs**

```{r}
#| label: dbarts_4_mse_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

::::::

:::::

#### dbarts + covariates

```{r}
#| label: dbarts_4b
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

::::: {.panel-tabset}

##### Partial dependency plot

:::::: {.panel-tabset}

###### Sampled reefs
::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_1_mod_dbarts_4b.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: dbarts_4b_pred_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- dbarts modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **Sampled reefs**
```{r}
#| label: dbarts_4b_mse_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

###### All reefs

::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_2_mod_dbarts_4b.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: dbarts_4b_pred_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- dbarts modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **All reefs**

```{r}
#| label: dbarts_4b_mse_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

:::::

::::


#### xgboost + covariates

```{r}
#| label: xgboost_4b
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

::::: {.panel-tabset}

##### Partial dependency plot

:::::: {.panel-tabset}

###### Sampled reefs
::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_1_mod_xgboost_4b.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: xgboost_4b_pred_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- xgboost modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **Sampled reefs**
```{r}
#| label: xgboost_4b_mse_1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

###### All reefs

::: {.columns}
:::: {.column width="50%"}
![](../output/figures/R_pdp_2_mod_xgboost_4b.png){width=350px}
::::
:::: {.column width="50%"}
```{r}
#| label: xgboost_4b_pred_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- xgboost modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **All reefs**

```{r}
#| label: xgboost_4b_mse_2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

:::::

::::

#### pymc-bart + covariates

```{python}
#| label: python sampled data barts data 4
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

```{python}
#| label: python sampled data barts fit 4
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

::::: {.panel-tabset}

##### Partial dependency plot (sample data only)

:::::: {.panel-tabset}

###### Sampled reefs
::: {.columns}
:::: {.column width="50%"}
![](../output/figures/python_pdp_pymc_bart_4b.png){width=350px}
::::
:::: {.column width="50%"}
```{python}
#| label: python sampled data barts prep plot 4
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
```{python}
#| label: python sampled data barts plot 4
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- pymc-barts modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **Sampled reefs**
```{python}
#| label: python sampled data pymc_barts mse 4b 1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

###### All reefs

::: {.columns}
:::: {.column width="50%"}
![](../output/figures/python_pdp_pymc_bart_4c.png){width=350px}
::::
:::: {.column width="50%"}
```{python}
#| label: python sampled data barts prep plot 4c
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
```{python}
#| label: python sampled data barts plot 4c
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
 
Partial dependencies based on estimated marginalised means for year

- sampled reefs (blue and green dashed lines)
- pymc-barts modelled estimates (orange ribbon, white line)
::::
:::

Calculate MSE of predictions to **All reefs**

```{python}
#| label:  python sampled data pymc_barts mse 4b 2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

:::::

::::

#### Comparisons
     
```{r}
#| label: comparison_4
#| results: markup
#| eval: false
#| echo: true
#| code-fold: true
#| cache: false
```
 
::: {#fig-mse_4_1}
![](../output/figures/mse_4_1.png){width=800px}

Mean square error (MSE) of models build on Northern reefs data (25
reefs) and compared to either reef/year level data. This represents
the models' ability to represent median-scale spatio-temporal
patterns. Smaller values imply smaller error since predicted values
are closer to the observed values. Panel columns condition MSE into
predicting data from either all Northern reefs, all Southern reefs or
only the sampled Northern reefs. Panel rows condition MSE into whether
models contained covariates or not.

:::

::: {#fig-mse_4_2}
![](../output/figures/mse_4_2.png){width=800px}

Mean inaccuracy (%) of models build on Northern reefs data (25
reefs) and compared to either reef/year level data. This represents
the models' ability to represent median-scale spatio-temporal
patterns. Smaller values imply smaller inaccuracy since predicted values
are closer to the observed values. Panel columns condition MSE into
predicting data from either all Northern reefs, all Southern reefs or
only the sampled Northern reefs. Panel rows condition MSE into whether
models contained covariates or not.

:::

```{r}
#| label: comparison_4_tab
#| results: markup
#| eval: true
#| echo: true
#| code-fold: true
#| cache: false
comps_4 <- readRDS(file = paste0(data_path,
                                        "synthetic/comps_4.rds")
                          ) 
comps_4 |> knitr::kable()
```
      


:::


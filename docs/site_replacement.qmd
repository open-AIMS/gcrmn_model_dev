---
title: "Comparing model types - site replacement"
author: "Murray Logan"
date: today
date-format: "DD/MM/YYYY"
format:
  html:
    ## Format
    theme: [default, resources/style.scss]
    css: resources/style.css
    html-math-method: mathjax
    ## Table of contents
    toc: true
    toc-float: true
    ## Numbering
    number-sections: true
    number-depth: 3
    ## Layout
    page-layout: full
    fig-caption-location: "bottom"
    fig-align: "center"
    fig-width: 4
    fig-height: 4
    fig-dpi: 72
    tbl-cap-location: top
    ## Code
    code-fold: false
    code-tools: true
    code-summary: "Show the code"
    code-line-numbers: true
    code-block-border-left: "#ccc"
    code-copy: true
    highlight-style: atom-one
    ## Execution
    execute:
      echo: true
      #cache: true
    ## Rendering
    embed-resources: true
crossref:
  fig-title: '**Figure**'
  fig-labels: arabic
  tbl-title: '**Table**'
  tbl-labels: arabic
engine: knitr
## execute: 
##   cache: true
jupyter: python3
output_dir: "docs"
documentclass: article
fontsize: 12pt
mainfont: Arial
mathfont: LiberationMono
monofont: DejaVu Sans Mono
classoption: a4paper
bibliography: resources/references.bib
---

```{r}
#| label: setup
#| include: false

knitr::opts_chunk$set(
    cache.lazy = FALSE,
    tidy = "styler"
)
## allow indented chunks
assignInNamespace(".sep.label",
  "^\\ *(#|--)+\\s*(@knitr|----+)(.*?)-*\\s*$",
    ns = "knitr"
)
knitr::read_chunk("../R/site_replacement.R")
knitr::read_chunk("../python/site_replacement.py")
```

## Purpose

## Preparations

::: {.panel-tabset}

### R
Load the necessary R libraries

```{r}
#| label: site replacement libraries
#| output: false
#| eval: true
#| warning: false
#| message: false
#| cache: false
```

Establish the global environment and paths

```{r}
#| label: site replacement global parameters
#| results: hide
#| eval: true
#| echo: true
#| cache: false
```

### Python

```{python}
#| label: python site replacement libraries
#| output: false
#| eval: true
#| warning: false
#| message: false
#| cache: false
```
```{python}
#| label: python site replacement global parameters
#| results: hide
#| eval: true
#| echo: true
#| cache: false
```
:::

## Import data

::: {.panel-tabset}

### R

:::: {.panel-tabset}

#### 1. Full reef level spatio-temporal benthic data

```{r}
#| label: read all reefs data
#| results: markup
#| eval: true
#| echo: true
#| cache: true
```

```{r}
#| label: read all reefs data show
#| results: markup
#| eval: true
#| echo: true
#| cache: true
#| dependson: "read all reefs data"
#| code-fold: false
benthos_reefs_sf 
```

```{r}
#| label: all reefs temporal summary
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

```{r}
#| label: all reefs temporal summary plot
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| code-fold: true
#| cache: true
#| dependson: "read all reefs data"
```

![](../output/figures/R_all_temporal_summary_plot.png){width=500px}

#### 2. All sampled reefs

```{r}
#| label: read sampled reefs data
#| results: markup
#| echo: true
#| cache: false
#| dependson: "read all reefs data"
```

```{r}
#| label: read sampled reefs data show
#| results: markup
#| eval: true
#| echo: true
#| cache: false
#| dependson: "read all reefs data"
#| code-fold: false
benthos_fixed_locs_obs 
```

```{r}
#| label: sampled simple raw means
#| results: markup
#| eval: false
#| echo: true
#| code-fold: true
#| cache: false
#| dependson: "read sampled reefs data"
```

```{r}
#| label: sampled simple raw means plot
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| code-fold: true
#| cache: false
#| dependson: "read sampled reefs data"
```

![](../output/figures/R_full_simple_raw_means_plot.png){width=500px}

#### 3. Replace a reef

```{r}
#| label: read sampled reefs data 1
#| results: markup
#| echo: true
#| cache: false
#| dependson: "read all reefs data"
```

```{r}
#| label: read sampled reefs data 1 show
#| results: markup
#| eval: true
#| echo: true
#| cache: false
#| dependson: "read all reefs data"
#| code-fold: false
benthos_fixed_locs_obs_1 
```

```{r}
#| label: sampled reefs data 1 plot
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| code-fold: true
#| cache: false
#| dependson: "read sampled reefs data"
```

![](../output/figures/R_sampled_reefs_1_plot.png){width=500px}

#### 4. Replace a reef (V2)

```{r}
#| label: read sampled reefs data 2
#| results: markup
#| echo: true
#| cache: false
#| dependson: "read all reefs data"
```

```{r}
#| label: read sampled reefs data 2 show
#| results: markup
#| eval: true
#| echo: true
#| cache: false
#| dependson: "read all reefs data"
#| code-fold: false
benthos_fixed_locs_obs_2 
```

```{r}
#| label: sampled reefs data 2 plot
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| code-fold: true
#| cache: false
#| dependson: "read sampled reefs data"
```

![](../output/figures/R_sampled_reefs_2_plot.png){width=500px}

::::

### Python

:::: {.panel-tabset}

#### 1. Full reef level spatio-temporal benthic data

```{python}
#| label: python read all reefs data
#| results: markup
#| eval: true
#| echo: true
#| cache: true
```
     
```{python}
#| label: python read all reefs data show
#| results: markup
#| eval: true
#| echo: true
#| cache: true
#| dependson: "read all reefs data"
#| code-fold: false
```

```{python}
#| label: python all reefs temporal summary
#| results: markup
#| eval: false
#| echo: true
#| cache: true
#| code-fold: true
```

```{python}
#| label: python all reefs temporal summary plot
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| code-fold: true
#| cache: true
```

![](../output/figures/Python_all_temporal_summary_plot.png){width=500px}

#### 2. All sampled reefs

```{python}
#| label: python read sampled reefs data
#| results: markup
#| eval: true
#| echo: true
#| cache: false
```
```{python}
#| label: python read sampled reefs data show
#| results: markup
#| eval: true
#| echo: true
#| cache: false
```

```{r}
#| label: python sampled simple raw means
#| results: markup
#| eval: false
#| echo: true
#| code-fold: true
#| cache: false
```

```{r}
#| label: python sampled simple raw means plot
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| code-fold: true
#| cache: false
#| dependson: "read sampled reefs data"
```

![](../output/figures/Python_full_simple_raw_means_plot.png){width=500px}

#### 3. Replace a reef

```{python}
#| label: python read sampled reefs data 1
#| results: markup
#| echo: true
#| cache: false
#| dependson: "read all reefs data"
```

```{python}
#| label: python read sampled reefs data 1 show
#| results: markup
#| eval: true
#| echo: true
#| cache: false
```

```{python}
#| label: python sampled reefs data 1 plot
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| code-fold: true
#| cache: false
#| dependson: "read sampled reefs data"
```

![](../output/figures/Python_sampled_reefs_1_plot.png){width=500px}

#### 4. Replace a reef (V2)

```{python}
#| label: python read sampled reefs data 2
#| results: markup
#| echo: true
#| cache: false
#| dependson: "read all reefs data"
```

```{python}
#| label: python read sampled reefs data 2 show
#| results: markup
#| eval: true
#| echo: true
#| cache: false
```

```{python}
#| label: python sampled reefs data 2 plot
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| code-fold: true
#| cache: false
#| dependson: "read sampled reefs data"
```

![](../output/figures/Python_sampled_reefs_2_plot.png){width=500px}

::::

:::
 

## Data preparations

::: {.panel-tabset}

### R

:::: {.panel-tabset}

#### All sampled reefs

```{r}
#| label: sampled data prep 0
#| results: markup
#| eval: false
#| echo: true
#| cache: false
```
```{r}
#| label: newdata 0
#| results: markup
#| eval: false
#| echo: true
#| cache: false
```

#### Replace a reef

```{r}
#| label: sampled data prep 1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
```

```{r}
#| label: newdata 1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
```
#### Replace a reef (V2)

```{r}
#| label: sampled data prep 2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
```
```{r}
#| label: newdata 2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
```


::::

### Python

:::: {.panel-tabset}

#### All sampled reefs

```{python}
#| label: python sampled data prep 0
#| results: markup
#| eval: false
#| echo: true
#| cache: false
```
```{python}
#| label: python newdata 0
#| results: markup
#| eval: false
#| echo: true
#| cache: false
```

#### Replace a reef

```{python}
#| label: python sampled data prep 1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
```
```{python}
#| label: python newdata 1
#| results: markup
#| eval: false
#| echo: true
#| cache: false
```

#### Replace a reef (V2)

```{python}
#| label: python sampled data prep 2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
```
```{python}
#| label: python newdata 2
#| results: markup
#| eval: false
#| echo: true
#| cache: false
```

::::

:::

 

## Modelled trends

| Dataset            | Description         | Legend label(s)       |
|--------------------|---------------------|-----------------------|
| `benthos_reefs_sf` | All reef-level data | all mean / all median |
|                    |                     |                       |

| Model  | Description                       |
|--------|-----------------------------------|
| Simple | Simple hierarchical means/medians |
|        |                                   |

::: {.panel-tabset}

### All sampled reefs

:::: {.panel-tabset}

#### glmmTMB

```{r}
#| label: glmmTMB_0
#| results: markup
#| eval: false
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "read sampled reefs data"
```

::::: {.panel-tabset}

##### Partial dependency plot

```{r}
#| label: glmmTMB_0_emmeans
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

```{r}
#| label: glmmTMB_0_emmeans plot
#| eval: false
#| results: markup
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| code-fold: true
#| cache: true
#| dependson: "glmmTMB_0"
```

![](../output/figures/R_pdp_mod_glmmTMB_0.png){width=500px}

##### Model Validation

```{r}
#| label: glmmTMB_0_dharma
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| cache: false
#| code-fold: true
```

```{r}
#| label: glmmTMB_0_dharma plot
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 4
#| code-fold: true
#| cache: true
#| dependson: "glmmTMB_0"
```

![](../output/figures/R_dharma_mod_glmmTMB_0.png){width=500px}

##### Summary

```{r}
#| label: glmmTMB_0_summary
#| results: markup
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "glmmTMB_0"
mod_glmmTMB_0 <- readRDS(
  file = paste0(data_path, "synthetic/mod_glmmTMB_0.rds")
)
mod_glmmTMB_0 |> summary()
```

:::::

#### brms

```{r}
#| label: brms_pre_0
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```

```{r}
#| label: brms_0
#| results: markup
#| eval: false
#| echo: true
#| code-fold: true
#| cache: true
#| dependson: "read sampled reefs data"
```

::::: {.panel-tabset}
##### Partial dependency plot

```{r}
#| label: brms_0_emmeans
#| results: markup
#| eval: false
#| echo: true
#| cache: false
#| code-fold: true
```
```{r}
#| label: brms_0_emmeans plot
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| code-fold: true
#| cache: true
#| dependson: "brms_0"
```

##### Sampling diagnostics

:::::: {.panel-tabset}

###### Traceplots

```{r}
#| label: brms_trace_0
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "brms_0"
```

###### Autocorrelation plots

```{r}
#| label: brms_ac_0
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "brms_0"
```

###### Rhat

```{r}
#| label: brms_rhat_0
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "brms_0"
```

###### Effective sample size

```{r}
#| label: brms_ess_0
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 10
#| fig-height: 8
#| code-fold: true
#| cache: true
#| dependson: "brms_0"
```
::::::

##### Model validation

```{r}
#| label: brms_ppc_0
#| results: markup
#| eval: false
#| echo: true
#| fig-width: 8
#| fig-height: 6
#| code-fold: true
#| cache: true
#| dependson: "brms_0"
```

:::::

::::

:::
 
